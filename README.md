# Buffer Overflow Analyzer

## 📑 Оглавление

### Основные разделы
- [🎯 Возможности](#-возможности)
  - [Основная утилита `bufanalyzer`](#основная-утилита-bufanalyzer)
  - [Фоновый демон `bufanalyzer-daemon`](#фоновый-демон-bufanalyzer-daemon)
- [📋 Системные требования](#-системные-требования)
  - [Обязательные зависимости](#обязательные-зависимости)
  - [Поддерживаемые дистрибутивы](#поддерживаемые-дистрибутивы)
- [🚀 Быстрый старт](#-быстрый-старт)
- [📖 Использование](#-использование)
  - [Командная утилита](#командная-утилита)
  - [Пример вывода](#пример-вывода)
  - [Автоматический анализ через демон](#автоматический-анализ-через-демон)
- [🔧 Конфигурация](#-конфигурация)
  - [Конфигурационный файл](#конфигурационный-файл)
  - [Systemd служба](#systemd-служба)
  - [Управление службой](#управление-службой)
- [📊 Формат отчётов](#-формат-отчётов)
  - [Пример отчёта](#пример-отчёта)
- [🔒 Модель безопасности](#-модель-безопасности)
  - [Принципы безопасности](#принципы-безопасности)
  - [Особенности реализации](#особенности-реализации)
- [🐛 Отладка и логирование](#-отладка-и-логирование)
  - [Просмотр логов](#просмотр-логов)
  - [Распространённые проблемы](#распространённые-проблемы)
- [🏗️ Архитектура](#️-архитектура)
  - [Компоненты системы](#компоненты-системы)
  - [Поток данных](#поток-данных)
- [📈 Обнаруживаемые функции](#-обнаруживаемые-функции)
  - [Опасные функции (уровень 2)](#опасные-функции-уровень-2)
  - [Функции с предупреждениями (уровень 1)](#функции-с-предупреждениями-уровень-1)
- [🧪 Тестирование](#-тестирование)
  - [Тестовые файлы](#тестовые-файлы)
  - [Запуск тестов](#запуск-тестов)
- [🛠️ Разработка](#️-разработка)
  - [Сборка RPM пакета](#сборка-rpm-пакета)
  - [Структура проекта](#структура-проекта)
  - [Внесение изменений](#внесение-изменений)
  - [Области для улучшения](#области-для-улучшения)

---

## 🎯 Возможности

### Основная утилита `bufanalyzer`
- **Статический анализ** C/C++ исходного кода
- **Обнаружение опасных функций**: `strcpy`, `gets`, `sprintf`, `strcat` и других
- **Категоризация рисков**: опасные функции и функции с предупреждениями
- **Цветной вывод** для быстрой визуальной идентификации проблем
- **Интеграция с syslog** для централизованного логирования
- **Простая установка** через make без необходимости сборки RPM

### Фоновый демон `bufanalyzer-daemon`
- **Автоматический мониторинг** каталога с исходными кодами
- **Мгновенная реакция** на новые файлы через inotify (без polling)
- **Генерация Markdown-отчётов** с детальной информацией о проблемах
- **Автоматическая архивация** обработанных файлов
- **Работа под непривилегированным пользователем** для повышения безопасности

## 📋 Системные требования

### Обязательные зависимости
- **inotify-tools** - для мониторинга файловой системы демоном
- **systemd** - для работы службы как systemd-юнита (опционально)
- **coreutils** - базовые утилиты (mkdir, chmod, chown и др.)
- **grep** - поиск и фильтрация в скриптах
- **shadow-utils** - управление пользователями (автоматическое создание пользователя)

### Поддерживаемые дистрибутивы
- Fedora 35+
- Другие дистрибутивы Linux с поддержкой inotify и systemd

## 🚀 Быстрый старт

Это руководство поможет быстро начать работу с Buffer Overflow Analyzer. Выберите один из способов установки:

### Вариант 1: Прямая установка через make (рекомендуется для разработки и тестирования)

```bash
# 1. Установите системные зависимости
sudo dnf install -y gcc make inotify-tools
# Для Debian/Ubuntu:
# sudo apt install -y gcc make inotify-tools

# 2. Клонируйте репозиторий
git clone https://github.com/kiberenotMIREA/bufanalyzer.git
cd bufanalyzer

# 3. Соберите и установите проект
make install
# Что делает:
# - Компилирует bufanalyzer и bufanalyzer-daemon
# - Устанавливает бинарные файлы в /usr/local/bin/
# - Копирует конфигурацию в /etc/
# - Создаёт пользователя и рабочие каталоги
# - Настраивает systemd службу (если systemd доступен)

# 4. Проверьте установку
bufanalyzer --help
```

### Вариант 2: Сборка и запуск без установки (для быстрого тестирования)

```bash
# 1. Установите зависимости компиляции
sudo dnf install -y gcc make
# Для Debian/Ubuntu:
# sudo apt install -y gcc make

# 2. Клонируйте репозиторий
git clone https://github.com/kiberenotMIREA/bufanalyzer.git
cd bufanalyzer

# 3. Соберите проект
make all
# Создаёт исполняемые файлы bufanalyzer и bufanalyzer-daemon в текущем каталоге

# 4. Протестируйте утилиту
./bufanalyzer --version
echo 'void test() { char buf[10]; strcpy(buf, "test"); }' > test.c
./bufanalyzer test.c

# 5. (Опционально) Запустите демон вручную
sudo mkdir -p /var/lib/bufanalyzer/{incoming,reports}
sudo chmod 755 /var/lib/bufanalyzer/{incoming,reports}
sudo ./bufanalyzer-daemon
```

### Вариант 3: Сборка RPM пакета (для production на RPM-системах)

```bash
# 1. Установите инструменты для сборки RPM
sudo dnf install -y rpm-build rpmdevtools gcc make inotify-tools systemd

# 2. Клонируйте репозиторий
git clone https://github.com/kiberenotMIREA/bufanalyzer.git
cd bufanalyzer

# 3. Соберите RPM пакет
make rpm
# Пакет будет создан в ~/rpmbuild/RPMS/x86_64/

# 4. Установите собранный пакет
sudo rpm -ivh ~/rpmbuild/RPMS/x86_64/buffer-overflow-analyzer-1.0-1.*.rpm
```

### Проверка установки

После установки любым способом проверьте работоспособность:

```bash
# Проверьте версию утилиты
bufanalyzer --version

# Проверьте статус службы (если установлен systemd вариант)
systemctl status bufanalyzer.service

# Протестируйте на примере
echo 'void test() { char buf[10]; strcpy(buf, "test"); gets(buf); }' > test.c
bufanalyzer test.c
```

### Краткая справка по командам сборки

| Команда | Назначение | Рекомендуется для |
|---------|------------|-------------------|
| `make all` | Только сборка | Быстрое тестирование |
| `make install` | Сборка + установка | Разработка, тестирование, production |
| `make rpm` | Сборка RPM пакета | Production на RPM-системах |
| `make clean` | Очистка сборки | Освобождение места |
| `make uninstall` | Удаление | Удаление установленных файлов |

### Быстрая проверка работы

1. **Проверьте утилиту командной строки:**
```bash
# Создайте тестовый файл с уязвимостью
cat > test.c << 'EOF'
#include <string.h>
void vulnerable() {
    char buffer[10];
    strcpy(buffer, "This string is too long!");
    gets(buffer);
}
EOF

# Проанализируйте файл
bufanalyzer test.c
```

2. **Проверьте работу демона (если установлен):**
```bash
# Поместите тестовый файл в мониторируемый каталог
sudo cp test.c /var/lib/bufanalyzer/incoming/

# Подождите несколько секунд и проверьте отчёт
sleep 3
ls -la /var/lib/bufanalyzer/reports/

# Просмотрите содержимое отчёта
cat /var/lib/bufanalyzer/reports/report_*.md
```

3. **Просмотрите логи демона:**
```bash
# Для systemd службы
journalctl -u bufanalyzer.service --since "1 minute ago"

# Для ручного запуска
sudo ./bufanalyzer-daemon  # в отдельном терминале
```

### Управление службой (если установлен systemd вариант)

```bash
# Статус службы
systemctl status bufanalyzer.service

# Запуск службы
sudo systemctl start bufanalyzer.service

# Остановка службы
sudo systemctl stop bufanalyzer.service

# Перезапуск службы
sudo systemctl restart bufanalyzer.service

# Включение автозапуска
sudo systemctl enable bufanalyzer.service

# Выключение автозапуска
sudo systemctl disable bufanalyzer.service
```

### Устранение типичных проблем

**Проблема:** Ошибка "command not found" для `bufanalyzer`
```bash
# Если установлен через make install
export PATH=/usr/local/bin:$PATH

# Если собрали через make all
./bufanalyzer  # используйте относительный путь
```

**Проблема:** Ошибка зависимостей
```bash
# Для Fedora/RHEL/CentOS
sudo dnf install -y gcc make inotify-tools

# Для Debian/Ubuntu
sudo apt install -y gcc make inotify-tools
```

**Проблема:** Демон не имеет доступа к каталогам
```bash
# Проверьте существование пользователя (по умолчанию user-12-31)
id user-12-31

# Если пользователь не создан
sudo useradd -r -s /sbin/nologin user-12-31

# Настройте права каталогов
sudo mkdir -p /var/lib/bufanalyzer/{incoming,reports}
sudo chown -R user-12-31:user-12-31 /var/lib/bufanalyzer
sudo chmod 750 /var/lib/bufanalyzer/{incoming,reports}
```

**Проблема:** Ошибка компиляции
```bash
# Проверьте установленные компиляторы
gcc --version
make --version

# Установите недостающие пакеты
sudo dnf install -y gcc make  # для RPM-систем
sudo apt install -y gcc make  # для Debian/Ubuntu
```

### Минимальный набор команд для начала работы

Для быстрого развертывания системы:

```bash
# 1. Установите зависимости
sudo dnf install -y gcc make inotify-tools git  # для RPM-систем
# или
sudo apt install -y gcc make inotify-tools git  # для Debian/Ubuntu

# 2. Получите исходный код
git clone https://github.com/kiberenotMIREA/bufanalyzer.git
cd bufanalyzer

# 3. Соберите и установите
make install

# 4. Проверьте
bufanalyzer --version

# 5. Запустите службу (если нужен демон)
sudo systemctl start bufanalyzer.service
sudo systemctl enable bufanalyzer.service
```

Теперь вы готовы использовать Buffer Overflow Analyzer!

## 📖 Использование

### Командная утилита
```bash
# Анализ одного файла
bufanalyzer ваш-файл.c

# Анализ нескольких файлов
bufanalyzer файл1.c файл2.c файл3.h

# Анализ всех файлов в директории
bufanalyzer src/*.c include/*.h

# Анализ с выводом в JSON (если поддерживается)
bufanalyzer --json ваш-файл.c
```

### Пример вывода
```
ОПАСНО: vulnerable.c:15 → strcpy()
ОПАСНО: vulnerable.c:27 → gets()
ПРЕДУПРЕЖДЕНИЕ: vulnerable.c:42 → strncpy()
```

### Автоматический анализ через демон
```bash
# Поместите файлы для анализа в мониторируемый каталог
sudo cp ваш-проект/*.c /var/lib/bufanalyzer/incoming/

# Отчёты автоматически появятся в
ls /var/lib/bufanalyzer/reports/

# Просмотр логов демона в реальном времени
journalctl -u bufanalyzer.service -f
```

## 🔧 Конфигурация

### Конфигурационный файл
Расположение: `/etc/bufanalyzer.conf`
```ini
# Пути к рабочим каталогам
INCOMING_DIR=/var/lib/bufanalyzer/incoming
REPORT_DIR=/var/lib/bufanalyzer/reports

# Уровень логирования (0-3, где 3 - самый подробный)
LOG_LEVEL=2

# Пользователь для запуска демона
DAEMON_USER=user-12-31
```

### Systemd служба (опционально)
- **Имя службы**: `bufanalyzer.service`
- **Пользователь**: `user-12-31` (создаётся автоматически)
- **Автозапуск**: отключен по умолчанию
- **Перезапуск**: автоматический при сбоях

## 📊 Формат отчётов

Отчёты генерируются в формате Markdown с именем:
```
report_ГГГГ-ММ-ДД_ЧЧММСС_имя-файла.md
```

### Пример отчёта
```markdown
# Отчёт статического анализа

**Файл:** `vulnerable.c`
**Дата анализа:** 2023-12-01_143025

**Опасных вызовов:** 3
**Предупреждений:** 2

## Обнаруженные проблемы

- **ОПАСНО** строка 15: `strcpy()`
- **ОПАСНО** строка 27: `gets()`
- **ПРЕДУПРЕЖДЕНИЕ** строка 42: `strncpy()`
- **ПРЕДУПРЕЖДЕНИЕ** строка 56: `strncat()`

## Безопасные альтернативы

- Вместо `strcpy()` используйте `strncpy()` с явным ограничением длины
- Вместо `gets()` используйте `fgets()` с указанием размера буфера
- Вместо `sprintf()` используйте `snprintf()` с указанием размера буфера
```

## 🔒 Модель безопасности

### Принципы безопасности
1. **Минимальные привилегии**: Демон работает под непривилегированным пользователем
2. **Изоляция**: Рабочие каталоги доступны только службе
3. **Контроль доступа**: Права 750 (владелец: всё, группа: чтение+исполнение)
4. **Безопасное выполнение**: Автоматическое понижение привилегий при запуске от root

### Особенности реализации
- **Динамическое понижение прав**: Если запущено от root, привилегии понижаются
- **Проверка границ буферов**: Предотвращение переполнений в самом анализаторе
- **Безопасное освобождение памяти**: Корректная работа с динамической памятью
- **Валидация входных данных**: Проверка всех пользовательских входных данных

## 🐛 Отладка и логирование

### Просмотр логов
```bash
# Все логи службы (если используется systemd)
journalctl -u bufanalyzer.service

# Логи за сегодня
journalctl -u bufanalyzer.service --since today

# Логи в реальном времени
journalctl -u bufanalyzer.service -f

# Логи демона при ручном запуске
./bufanalyzer-daemon --verbose 2>&1 | tail -f
```

### Распространённые проблемы

**Проблема**: Демон не запускается
```bash
# Проверьте статус (если systemd)
systemctl status bufanalyzer.service

# Проверьте наличие зависимостей
which inotifywait

# Проверьте конфигурацию
cat /etc/bufanalyzer.conf
```

**Проблема**: Нет доступа к каталогам
```bash
# Проверьте права доступа
ls -la /var/lib/bufanalyzer/

# Исправьте права (если необходимо)
sudo chown -R user-12-31:user-12-31 /var/lib/bufanalyzer
sudo chmod 750 /var/lib/bufanalyzer/{incoming,reports}
```

**Проблема**: Не обнаруживаются опасные функции
```bash
# Проверьте синтаксис файла
gcc -fsyntax-only ваш-файл.c

# Проверьте чувствительность к регистру
# Анализатор чувствителен к регистру: strcpy() обнаружится, но Strcpy() - нет
```

## 🏗️ Архитектура

### Компоненты системы
```
┌─────────────────────────────────────────────────────────────┐
│                    Пользователь                             │
│  bufanalyzer (CLI утилита)                                  │
└───────────────┬─────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────┐
│                    Система                                  │
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │ /usr/local/bin/ │    │ /etc/           │                │
│  │ • bufanalyzer   │    │ • bufanalyzer.  │                │
│  │ • bufanalyzer-  │    │   conf          │                │
│  │   daemon        │    └─────────────────┘                │
│  └─────────────────┘                                       │
└───────────────┬─────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────┐
│                    Демон (bufanalyzer-daemon)               │
│  • Мониторинг inotify                                       │
│  • Статический анализ                                       │
│  • Генерация отчётов                                        │
└───────────────┬─────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────┐
│                    Файловая система                         │
│  ┌─────────────────┐          ┌─────────────────┐          │
│  │ incoming/       │          │ reports/        │          │
│  │ • file1.c       │───────▶  │ • report_...    │          │
│  │ • file2.h       │          │ • report_...    │          │
│  └─────────────────┘          └─────────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

### Поток данных
1. Пользователь помещает C/H файлы в `incoming/`
2. Inotify обнаруживает новые файлы
3. Демон анализирует каждый файл
4. Создаётся Markdown-отчёт в `reports/`
5. Исходный файл архивируется в `incoming/processed_*`

## 📈 Обнаруживаемые функции

### Опасные функции (уровень 2)
Эти функции гарантированно подвержены переполнению буфера:

| Функция | Описание | Безопасная альтернатива |
|---------|----------|-------------------------|
| `strcpy()` | Копирование строки без проверки | `strncpy()` |
| `strcat()` | Конкатенация строк без проверки | `strncat()` |
| `sprintf()` | Форматированный вывод в строку | `snprintf()` |
| `vsprintf()` | Вариативный форматированный вывод | `vsnprintf()` |
| `gets()` | Чтение строки из stdin (удалена из C11) | `fgets()` |
| `realpath()` | Может переполнить буфер результата | `realpath()` с NULL |
| `getwd()` | Устаревшая, использует буфер фиксированного размера | `getcwd()` |
| `scanf()` семейство | Может переполнить буфер без ограничений | Используйте ограничители ширины |

### Функции с предупреждениями (уровень 1)
Эти функции могут быть безопасными при правильном использовании:

| Функция | Риск | Рекомендации |
|---------|------|--------------|
| `strncpy()` | Может не завершить строку нулём | Явно устанавливайте `'\0'` |
| `strncat()` | Сложно правильно использовать | Тщательно рассчитывайте длину |
| `snprintf()` | Нужно проверять возвращаемое значение | Всегда проверяйте возврат |
| `vsnprintf()` | Аналогично `snprintf()` | Всегда проверяйте возврат |
| `memcpy()` | Может выйти за границы, если размер неверен | Проверяйте размеры буферов |

## 🧪 Тестирование

### Тестовые файлы
Проект включает примеры для проверки работы:

- `test/vulnerable.c` - содержит опасные вызовы
- `test/safe.c` - пример безопасного кода

### Запуск тестов
```bash
# Проанализируйте тестовые файлы
bufanalyzer test/vulnerable.c test/safe.c

# Проверьте работу демона
sudo cp test/vulnerable.c /var/lib/bufanalyzer/incoming/
sleep 2
ls /var/lib/bufanalyzer/reports/

# Запустите тестовый сценарий
make test
```

## 🛠️ Разработка

### Сборка проекта
```bash
# Сборка всех компонентов
make all

# Сборка только основной утилиты
make bufanalyzer

# Сборка только демона
make bufanalyzer-daemon

# Очистка сборки
make clean
```

### Структура проекта
```
bufanalyzer/
├── src/
│   ├── bufanalyzer.c         # Основная утилита
│   ├── bufanalyzer-daemon.c  # Фоновый демон
│   └── common.c              # Общие функции
├── config/
│   └── bufanalyzer.conf      # Конфигурация
├── service/
│   └── bufanalyzer.service   # Systemd unit-файл
├── test/                     # Тестовые файлы
├── Makefile                  # Автоматизация сборки
├── README.md                 # Документация
├── LICENSE                   # Лицензия GPLv3
└── CHANGELOG.md              # История изменений
```

### Внесение изменений
1. Внесите изменения в исходный код
2. Обновите версию в Makefile
3. Протестируйте изменения
4. Обновите документацию
5. Обновите CHANGELOG.md

### Области для улучшения
1. **Дополнительные проверки**: Обнаружение уязвимостей форматных строк, целочисленных переполнений
2. **Поддержка языков**: Анализ C++, Rust, Go
3. **Интеграция**: Плагины для VS Code, IntelliJ, CI/CD системы
4. **Улучшение отчётов**: Графики, статистика, автоматические рекомендации по исправлению
5. **Производительность**: Оптимизация для больших проектов, кэширование результатов